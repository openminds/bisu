require_relative '../test_helper'
require 'yaml'

def vulnerability_data
  @vulnerability_data ||= File.read('./test/fixtures/wheezy_vulnerability_data.txt')
end

def vulnerabilities_fixtures
  @vulnerabilities_fixures ||= YAML.load_file('./test/fixtures/wheezy_vulnerabilities.yml')
end

def cve_list_fixtures
  @cve_list_fixtures ||= YAML.load_file('./test/fixtures/wheezy_cve_list.yml')
end

describe Bisu::VulnerabilityParser::Debian do
  describe '#source' do
    it 'returns the URL ending with the platform name if a platform is specified' do
      assert Bisu::VulnerabilityParser::Debian.new(platform: Bisu::Platform.new(name: 'foobar')).source =~ /foobar$/
    end

    it 'returns the URL ending with GENERIC if no platform is specified' do
      assert Bisu::VulnerabilityParser::Debian.new.source =~ /GENERIC$/
    end
  end

  describe '#vulnerabilities' do
    it 'returns correctly built objects' do
      parser = Bisu::VulnerabilityParser::Debian.new(platform: 'wheezy')
      parser.stub(:vulnerability_data, vulnerability_data) do
        assert parser.vulnerabilities == vulnerabilities_fixtures
      end
    end
  end

  describe '#cve_list' do
    it 'returns a correctly built hash' do
      parser = Bisu::VulnerabilityParser::Debian.new(platform: 'wheezy')
      parser.stub(:vulnerability_data, vulnerability_data) do
        assert parser.send(:cve_list) == cve_list_fixtures
      end
    end
  end
end
